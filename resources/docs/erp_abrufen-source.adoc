include::./config-source.adoc[]

= E-Rezept API-Dokumentation für Apotheker
Hier dokumentiert die gematik die Nutzung der Schnittstellen rund um das E-Rezept aus Sicht des abgebenden Leistungserbringers.

toc::[]

==  Anwendungsfall E-Rezept beliefern
Mit diesem UseCase beliefert ein Apotheker ein E-Rezept, das auf dem E-Rezept-Fachdienst bereitliegt. Eine Unterscheidung zwischen einer Filial- oder Versandapotheke ist dabei zweitrangig, da der Unterschied im Ablauf lediglich in der Übermittlung der `Task-ID` und des `AccessCodes` durch den Versicherten besteht.
Mit der Bekanntmachung der `Task-ID` und des `AccessCodes` durch den Versicherten mittels Präsentation eines 2D-Barcodes oder via Kommunikationsnachricht liegen im Apothekenverwaltungssystem (AVS) alle notwendigen Parameter für den Abruf des Rezepts vor. +
Ist der Task inkl. des E-Rezept-Datensatzes heruntergeladen, prüft das AVS die Signatur des E-Rezept-Datensatzes mit Hilfe des Konnektors.
Ist das E-Rezept gültig signiert und das E-Rezept beliefert, erfolgt der Abschluss der Transaktion mit dem Bereitstellen der Dispensierinformationen für den Versicherten.
Der E-Rezept-Fachdienst erzeugt daraufhin eine Signatur als Quittung für den Apotheker und den Versicherten und beendet den Workflow.

image:api_rezept_abrufen.png[width=100%]

NOTE: Im Ablaufdiagramm sind zusätzliche Arbeitsschritte des Apothekenpersonals wie Securpharm-Scan und Zuzahlung des Patienten nicht berücksichtigt.

== Profilierung
Für diesen Anwendungsfall werden die FHIR-Resourcen "Task": http://hl7.org/fhir/task.html und MedicationDispense https://www.hl7.org/fhir/medicationdispense.html profiliert.
Die Profile können als JSON oder XML hier eingesehen werden: https://simplifier.net/erezept-workflow/gem_erp_pr_task bzw. https://simplifier.net/erezept-workflow/gem_erp_pr_medicationdispense

Die für diese Anwendung wichtigen Attribute und Besonderheiten durch die Profilierung der Ressourcen werden in der folgenden Tabelle kurz zusammengefasst:
|===
|*Name* |*Beschreibung*
2+s|Task
|identifier:PrescriptionID |Rezept-ID; eindeutig für jedes Rezept
|identifier:AccessCode |vom E-Rezept-Fachdienst generierter Berechtigungs-Code
|identifier:Secret |vom E-Rezept-Fachdienst generierter Berechtigungs-Code
|status |Status des E-Rezepts
|intent |Intension des Tasks. Fixer Wert="order"
|for |Krankenversichertennummer
|authoredOn |Erstellungszeitpunkt des Tasks
|lastModified |letzte Änderung am Task
|performerType |Institution, in der das Rezept eingelöst werden soll
|input |Verweis auf die für den Patienten und den Leistungserbringer gedachten Bundle
|output |Verweis auf das Quittungs-Bundle
|extension:flowType |gibt den Typ des Rezeptes an
|extension:expiryDate |Verfallsdatum
|extension:acceptDate |Datum bis zu welchem die Krankenkasse spätestens die Kosten übernimmt
2+s|MedicationDispense
|identifier:PrescriptionID |Rezept-ID; eindeutig für jedes Rezept
|status |Status des E-Rezepts
|medication |das dem Versicherten ausgehändigte Medikament
|subject:identifier |Krankenversichertennummer
|performer |Telematik-ID der Apotheke, die das E-Rezept beliefert hat
|whenHandedOver |Datum der Übergabe bzw. Herausgabe an den Versicherten
|dosageInstruction |Dosierungsinformationen des Medikaments, falls abweichend von der ärztlichen Verordnung
2+s|Medication innerhalb MedicationDispense
|code |Enthält je nach Rezepttyp die PZN und den Handelsnamen, Kennzeichnung als Wirkstoffverordnung oder eine Rezeptur
|form |Darreichungsform (Tabletten, Kapseln, Salbe, etc.)
|ingredient |Wirkstoff bei Wirkstoffverordnung
|batch |Chargeninformation
|===

In den folgenden Kapiteln wird erläutert, wann und wie die Befüllung dieser Attribute erfolgt.


== E-Rezept abrufen
Ein Apotheker hat vom Versicherten mittels Abscannen eines 2D-Codes die Informationen `https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58/$accept?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea` für den Abruf eines E-Rezepts vom E-Rezept-Fachdienst erhalten.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$accept`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?ac=...` muss der beim Erzeugen des Tasks generierte `AccessCode` für die Berechtigungsprüfung übergeben werden.
Im http-ResponseBody wird der referenzierte Task sowie das qualifiziert signierte E-Rezept als E-Rezept-Datensatz zurückgegeben, wobei im Task das `secret` als zusätzliches Geheimnis in einem Task.identifier generiert wird, das in allen folgenden Zugriffen durch den Apotheker mitgeteilt werden muss.

*Request*
[cols="h,a"]
[%autowidth]
|===
|URI        |https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58/$accept?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----

NOTE: Im http-Header des äußeren http-Requests an die VAU (POST /VAU) sind die Header `X-erp-user: l` und `X-erp-resource: Task` zu setzen.

|===


*Response*
[source,xml]
----
include::../examples/ti-dienste/task/response_taskAccept.xml[]
----
NOTE: Das generierte `Secret` stellt den Zugriffscode der abrufenden Apotheke dar und muss in allen folgenden Workflowschritten als `<identifier><value value="*"/></identifier>` angegeben werden, damit nicht eine fremde Apotheke den Prozess übernehmen kann.

NOTE: Der Status des Tasks unter `<status value="*"/>` ist in Bearbeitung (`in-progress`)

NOTE: Das Element `<Binary> <data value="*"/></Binary>` enthält den qualifiziert signierten Verordnungsdatensatz als PKCS#7-Datei in Base64-codierter Form. Innerhalb des Signaturobjekts ist das E-Rezept-Bundle enthalten (Enveloping-Signatur) und muss vom Apothekensystem für die Bearbeitung des E-Rezepts verarbeitet werden. Der codierte Base64-String ist hier aus Gründen der Lesbarkeit nicht vollständig dargestellt. Das vollständige Beispiel findet sich im Unterordner der link:../samples/qes/signed[Beispiele] in der Datei `4fe2013d-ae94-441a-a1b1-78236ae65680_S_SECUN_secu_kon_4.8.2_4.1.3.p7`



[cols="a,a"]
[%autowidth]
|===
s|Code   s|Type Success
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält die angefragten Daten.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept hat nicht den Status, dass es durch die Apotheke abgerufen werden kann.# +
[small]#Im OperationOutcome werden weitere Informationen gegeben:# +
[small]#"Task has invalid status completed"# +
[small]#"Task has invalid status in-progress"# +
[small]#"Task has invalid status draft"#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===

== Qualifizierte Signatur des E-Rezepts prüfen
Im Apothekenverwaltungssystem liegen nach dem Abruf aus dem E-Rezept-Fachdienst der Task des Workflows und der qualifiziert signierte Verordnungsdatensatz vor. Die Rechtmäßigkeit der elektronischen Verordnung wird mittels Prüfung der QES durch den Konnektor verifiziert. Nur bei gültiger qualifizierter elektronischer Signatur des E-Rezepts darf der Apotheker mit der Bearbeitung der Verordnung fortfahren. Für die Prüfung wird die soeben heruntergeladene PKCS#7-Datei in Base64-codierter Form an die SOAP-Schnittstelle der Signaturprüfung des Konnektors als http-POST-Operation geschickt.

*Request*
[cols="h,a"]
[%autowidth]
|===
|URI        |https://192.168.x.y/Konnektorservice
|Method     |POST
|HTTP Header |
----
Content-Type: text/xml; charset=UTF-8
Content-Length: 1234
----

|Payload    |
[source,xml]
----
include::../examples/konnektorservice/request_VerifySignatureTask.xml[]
----

NOTE: Das Element `<m2:Base64Signature></m2:Base64Signature>`enthält das Signaturelement inkl. des signierten E-Rezept-Datensatzes (CAdES-enveloping) als PKCS#7-Datei in Base64-Codierung

NOTE: Mit dem Attribut `<m:IncludeRevocationInfo>false</m:IncludeRevocationInfo>` wird der Konnektor beim Prüfen der Signatur angewiesen, eine im Signaturobjekt enthaltene Statusabfrage des Signaturzertifikats zu verwenden und keine eigene OCSP-Statusabfrage zu starten.

|===

NOTE: Der Inhalt der Base64-codierten Signatur findet sich im Unterordner der link:../samples/qes/signed[Beispiele] in der Datei `4fe2013d-ae94-441a-a1b1-78236ae65680_S_SECUN_secu_kon_4.8.2_4.1.3.p7` und kann mit einem ASN.1-Viewer eingesehen werden.

IMPORTANT: Im Verzeichnis der link:../samples/qes/signed[Beispiele] sind alle Kreuzkombinationen der verschiedenen Konnektorhersteller für Signaturerstellung und -Prüfung enthalten. Hier dargestellt ist die Prüfung durch eine Koco-Box einer durch einen Secunet-Konnektor erstellten QES in `4fe2013d-ae94-441a-a1b1-78236ae65680_S_SECUN_secu_kon_4.8.2_4.1.3_V_KOCOC_kocobox_3.6.0_2.3.24_req.xml`.

IMPORTANT: Im Verzeichnis link:../samples/qes-cases/HBA-gueltig-bis-24.4.2021[HBA-gueltig-bis-24.4.2021] gibt es weitere Beispiele, wie die Signatur und Signaturprüfung aussieht, wenn ein HBA kurz vor dem Ablauf seiner kryptografischen Gültigkeit verwendet wurde.


*Response*
[source,xml]
----
include::../examples/konnektorservice/response_VerifySignatureTask.xml[]
----
NOTE: Hier dargestellt ist die QES-Signaturvalidierung einer Koco-Box der durch einen Secunet-Konnektor erzeugten Signatur aus `4fe2013d-ae94-441a-a1b1-78236ae65680_S_SECUN_secu_kon_4.8.2_4.1.3_V_KOCOC_kocobox_3.6.0_2.3.24_resp.xml`. Weitere Beispiele finden sich im Unterordner der link:../samples/qes/signed[Beispiele].

[cols="a,a"]
[%autowidth]
|===
s|Code   s|Type Success
|200  |OK  +
[small]#Die Anfrage wurde erfolgreich bearbeitet und das Ergebnis der Anfrage wird in der Antwort übertragen. Das gilt ebenso für Fehler in der Verarbeitung des SOAP-Requests, die als SOAP-Fault zurückgemeldet werden.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|===

== E-Rezept-Abgabe vollziehen
Ein Apotheker hat ein E-Rezept abgerufen und beliefert den Patienten mit dem Medikament. Beim Abschließen des Workflows muss der Rezept-Typ beachtet werden. Dieser wird durch das Element Task.extension.flowType bestimmt. Zum Abschluss des Worflows stellt der Apotheker dem Versicherten Informationen über das abgegebene Medikament bereit und erhält als Ergebnis eine signierte Quittung, die er in seinen Abrechnungsprozessen gegenüber dem Apothekenrechenzentrum bzw. der Krankenkasse als Nachweis des ordnungsgemäßen Abschlusses der Transaktion verwenden kann. Ist für das Element Task.extension.flowType.code "value=200" gesetzt, so handelt es sich hierbei um ein Rezept für eine privat versicherte Person. Hierbei muss der Apotheker dem Versicherten eine ausgedruckte Quittung übergeben, damit der Versicherte das Medikament gegenüber seiner Kostenstelle eigenständig abrechenen kann.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$close`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden. Zusätzlich werden Informationen über das ausgegebene Medikament an den Fachdienst übergeben.
Im http-ResponseBody wird die serverseitig über den Task und das E-Rezept-Bundle erzeugte Signatur als `Quittungs-Bundle`-Ressource zurückgegeben, die dem Apotheker gegenüber der Krankenkasse als Quittung dient.
NOTE: Zurzeit kann die Signatur	mit den Konnektor-Versionen PTV4, PTV4+ und PTV5 nicht geprüft werden.

*Request*
[cols="h,a"]
[%autowidth]
|===
|URI        |https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58/$close?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden.
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

NOTE: Im http-Header des äußeren http-Requests an die VAU (POST /VAU) sind die Header `X-erp-user: l` und `X-erp-resource: Task` zu setzen.

|Payload    |
[source,xml]
----
include::../examples/ti-dienste/task/request_taskClose.xml[]
----
NOTE: Mit der Übergabe der MedicationDispense signalisiert der Apotheker den Abschluss des E-Rezept-Workflows. Der Versicherte erhält Informationen über das abgegebene Medikament.

NOTE: Sofern kein Austausch des verordneten Medikaments erfolgte, können die Medikations-Informationen aus dem E-Rezept übernommen werden, beim Austausch gegen ein anderes Medikament müssen hier die entsprechenden Informationen angepasst werden, ebenso etwaig abweichende Dosierinformationen.

NOTE: Die Zeitangabe in `<whenHandedOver value` bezieht sich auf die Übergabe des Medikaments, wann wurde es dem Überbringer des E-Rezepts ausgehändigt.

NOTE: Die Codierung der Einnahmehinweise in `<dosageInstruction>` erfolgt z.B. in Textform [morgens-mittags-abends-nachts] in boolescher Notation 1=ja, 0=nein

|===

Es können auch mehrere MedicationDispenses für eine $close-Operation übergeben werden. Die MedicationDispenses werden in einem "collection"-Bundle verschickt.
NOTE: Der Fachdienst wird diese Funktion vorraussichtlich ab ende des ersten Quartals 2022 unterstützen.

.Beispiel für eine mehrfache Abgabe (Klicken zum Ausklappen)
[%collapsible]

====

[source,xml]
----
include::../examples/ti-dienste/task/request_taskCloseMultiple.xml[]
----

====


*Response*
[source,xml]
----
include::../examples/ti-dienste/task/response_taskClose.xml[]
----
NOTE: Im Ergebnis der Operation wird ein signiertes Bundle als Nachweis des ordnungsgemäßen Durchlaufs des E-Rezept-Workflows zurückgegeben.

NOTE:  Das signierte Quittungs-Bundle enthält unter `<identifier><value/>`</identifier>` die Rezept-ID für eine eindeutige Zuordnung aller Artefakte des durchlaufenen Workflows

NOTE: An der Stelle `<Composition><valueIdentifier/></Composition>` ist die Telematik-ID als Quittungsempfänger bzw. begünstigte Institution eingetragen, welche die Dispensierung des E-Rezepts vollzogen hat.

NOTE: Das Startdatum in `<period><start value="*"/></period>` entspricht dem Abrufdatum des E-Rezepts durch die Apotheke (Statuswechsel des Task: ready -> in-progress)

NOTE: Signaturzeitpunkt der Quittung in <period><end value="*"/></period>, entspricht dem Statuswechsel des Task in-progress -> completed

NOTE: Das unter `<fullUrl value="https://erp.zentral.erp.splitdns.ti-dienste.de/Device/*`/>` eingebettete Device identifiziert den E-Rezept-Fachdienst als Aussteller der Quittung.

NOTE: Unter `<Binary><data value="*"/></Binary>` wird der base64-codierte Hashwert, über den die QES des Verordnungsdatensatzes erstellt wurde eingebettet.

NOTE: Das Element `<signature>*</signature>` enthält die Signatur des Quittungs-Bundles über alle enthaltenen Objekte als Enveloping CAdES-Signatur in Base64-Codierung.



[cols="a,a"]
[%autowidth]
|===
s|Code   s|Type Success
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wurde vor dem Senden der Antwort erstellt. Das „Location“-Header-Feld enthält die Adresse der erstellten Ressource.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== E-Rezept zurückweisen
Ein Apotheker hat im vorherigen Schritt ein E-Rezept abgerufen und fachlich geprüft. Er kommt zu dem Schluss, das E-Rezept nicht zu beliefern und möchte nun das E-Rezept zurückweisen, damit der Versicherte das E-Rezept ggfs. in einer anderen Apotheke einlösen kann.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$reject`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden.

*Request*
[cols="h,a"]
[%autowidth]
|===
|URI        |https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58/$reject?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8;
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

NOTE: Im http-Header des äußeren http-Requests an die VAU (POST /VAU) sind die Header `X-erp-user: l` und `X-erp-resource: Task` zu setzen.

|===

*Response*
[source,xml]
----
HTTP/1.1 204 No Content
----
NOTE: Im Ergebnis der $reject-Operation wird der referenzierte Task auf den aktiven Status `ready` zurückgesetzt und das Secret gelöscht. Dementsprechend werden keine Daten an den aufrufenden Client zurückgegeben.


[cols="a,a"]
[%autowidth]
|===
s|Code   s|Type Success
|204  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== E-Rezept löschen
Ein Apotheker hat im vorherigen Schritt ein E-Rezept abgerufen und fachlich geprüft. Der Versicherte bittet ihn jedoch, das Rezept nicht zu beliefern sondern zu löschen, da er nicht über ein eigenes Gerät mit E-Rezept-App verfügt aber sein Recht auf informationelle Selbstbestimmung wahrnehmen möchte. Der Apotheker kommt diesem Wunsch nach und löscht das E-Rezept auf dem Fachdienst.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$abort`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden.

*Request*
[cols="h,a"]
[%autowidth]
|===
|URI        |https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58/$abort?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Leistungserbringer aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

NOTE: Im http-Header des äußeren http-Requests an die VAU (POST /VAU) sind die Header `X-erp-user: l` und `X-erp-resource: Task` zu setzen.

|===

*Response*
[source,xml]
----
HTTP/1.1 204 No Content
----
NOTE: Im Ergebnis der $abort-Operation wird der referenzierte Task gelöscht. Dementsprechend werden keine Daten an den aufrufenden Client zurückgegeben.


[cols="a,a"]
[%autowidth]
|===
s|Code   s|Type Success
|204  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== Quittung erneut abrufen
Als Apotheker kann es erforderlich sein, die Quittung für ein beliefertes E-Rezept erneut abzurufen (z.B. am Monatsende für Abrechnungszwecke, falls das Apothekenverwaltungssystem die Quittung nicht während der Belieferung gespeichert hat). Der Abruf ist möglich, solange das E-Rezept nicht automatisch und auch nicht durch den Versicherten gelöscht wurde.

*Request*
[cols="h,a"]
[%autowidth]
|===
|URI        | https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf

Zum Nachweis als berechtigte Apotheke, die das E-Rezept verarbeitet hat(te), muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
|Method     |GET
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE:  Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Leistungserbringer aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

NOTE: Im http-Header des äußeren http-Requests an die VAU (POST /VAU) sind die Header `X-erp-user: l` und `X-erp-resource: Task` zu setzen.

|===


*Response*
[source,xml]
----
include::../examples/ti-dienste/task/response_taskGet.xml[]
----
In `<resource><Bundle/></resource>` wird die Quittung wird als Objekt zusammen mit dem Task zurückgegeben

[cols="a,a"]
[%autowidth]
|===
s|Code   s|Type Success
|200  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält die angefragten Daten.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===

== Beispiele für DataMatrix-Codes (inkl. Schadcodes)
AVS-Systeme müssen im Feld mit einer Vielzahl von Varianten in den von Patienten vorgelegten DataMatrix-Codes rechnen. Die meisten werden von geprüften, zertifizierten Primärsystemen generiert, da der Markt aber offen ist und ebenso mit "Angriffen" zu rechnen ist, zeigt die folgende Liste einige reale Beispiele.

IMPORTANT: Always sanitize user inputs.

image:datamatrix_sample_3.png[width=230px]

image:dm_evil_input.png[width=230px]

image:dm_gruesse.png[width=230px]

image:dm_padding_ascii.png[width=230px]

image:dm_padding_whitespace.png[width=230px]

image:datamatrix_sample.png[width=230px]

image:dm_pwned.png[width=230px]

image:dm_script.png[width=230px]
