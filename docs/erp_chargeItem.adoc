// asciidoc settings for DE (German)
// ==================================
:imagesdir: ../images
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:toc: macro
:toclevels: 3
:toc-title: Inhaltsverzeichnis
image:gematik_logo.png[width=35%]

= E-Rezept API-Dokumentation für die PKV-Abrechnungsinformationen
Hier dokumentiert die gematik die Nutzung der Schnittstellen rund um das E-Rezept für die elektronische Verarbeitung und Speicherung von Abrechnungsinformationen für PKV-Versicherte.

toc::[]

== Profilierung
Für diesen Anwendungsfall wird die FHIR-Ressource "ChargeItem": http://hl7.org/fhir/chargeitem.html profiliert.
Die Profile können als JSON- oder XML-Datei hier eingesehen werden: https://simplifier.net/erezept-patientenrechnung/gem-erpchrg-pr-chargeitem

Die für diese Anwendung wichtigen Attribute und Besonderheiten durch die Profilierung der Ressourcen werden in der folgenden Tabelle kurz zusammengefasst:
|===
|*Name* |*Beschreibung*
2+s|ChargeItem
|extension.markingFlag |Boolsche Werte für den Versicherten zum Markieren, ob das ChargeItem bei Institutionen eingereicht wurde
|identifier.PrescriptionId |ID des ChargeItems, zugleich Rezept-ID
|identifier.AccessCode |Geheimnis zum Ändern des ChargeItems
|status |Status des ChargeItems. Fester Wert auf "billable"
|code |Pflichtfeld, welches nicht verwendet wird. Verwenden Sie das Codesystem http://terminology.hl7.org/CodeSystem/data-absent-reason#not-applicable.
|subject |Versicherten-ID des PKV-Patienten
|enterer |Telematik-ID der abgebenden LEI
|enteredDate |Zeitstempel der Erstellung eines ChargeItem
|supportingInformation |Referenz auf die drei Bestandteile der Abrechnungsinformationen (Verordnungs-, Abgabedatensatz und die Quittung)
|===

In den folgenden Kapiteln wird erläutert, wann und wie die Befüllung dieser Attribute erfolgt.

==  Anwendungsfall PKV-Abrechnungsinformationen durch den abgebenden Leistungserbringer bereitstellen
Als Apotheker möchte ich dem Versicherten seine Abrechnungsinformationen bereitstellen. Die Abrechnungsinformationen werden über die FHIR-Ressource "ChargeItem" abgebildet. Das ChargeItem enthält Referenzen auf die dazugehörenden Datensätze (als Bundle abgebildet), Verordnungsdatensatz, Abgabedatensatz und die Quittung.
Der Abgabedatensatz wird als Contained-Objekt in dem ChargeItem mitgegeben. Der E-Rezept-Fachdienst extrahiert dieses Binary, speichert es gesondert ab und erstellt eine Referenz in der ChargeItem-Resource.
Das Attribut "ChargeItem.Code" ist nach dem FHIR-Standard ein Pflichtfeld, wird aber in diesem Kontext fachlich nicht benötigt. Deshalb wird hier ein Platzhalter-Codesystem angewendet.

Der Aufruf erfolgt als http-`POST`-Operation auf die Ressource `/ChargeItem`. Im http-Request-Header Authorization muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter ?secret=…​ muss das beim Abrufen des E-Rezepts (`$accept`) im Task generierte Secret für die Berechtigungsprüfung übergeben werden.

*Request*
[cols="h,a"]
|===
|URI        |https://prescriptionserver.telematik/ChargeItem?task=200.086.824.605.539.20&secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +
Mit dem Parameter `task=...` wird die Zuordnung zum Task des eingelösten Rezepts hergestellt. +
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden.
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Apotheke aus, im Token ist die `TelematikID` und `professionOID` für die Rollenprüfung enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

NOTE: Im http-Header des äußeren http-Requests an die VAU (POST /VAU) sind die Header `X-erp-user: l` (kleines L) und `X-erp-resource: ChargeItem` zu setzen.

|Payload    |
[source,xml]
----
<ChargeItem xmlns="http://hl7.org/fhir">
    <meta>
        <profile value="https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0" />
    </meta>
    <contained>
        <Binary>
            <id value="Abg123"/>
            <!--Hier kommt das Abgabdedatensatz-Bundle rein. Siehe https://simplifier.net/erezeptabgabedatenpkv -->
        </Binary>
    </contained>
    <identifier>
        <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId" />
        <value value="200.086.824.605.539.20" />
    </identifier>
    <status value="billable" />
    <code>
        <coding>
            <system value="http://terminology.hl7.org/CodeSystem/data-absent-reason" />
            <code value="not-applicable" />
        </coding>
    </code>
    <subject>
        <identifier>
            <value value="X234567890" />
            <assigner>
                <display value="Name einer privaten Krankenversicherung" />
            </assigner>
        </identifier>
    </subject>
    <enterer>
        <identifier>
            <system value="https://gematik.de/fhir/sid/telematik-id" />
            <value value="3-15.2.1456789123.191" />
        </identifier>
    </enterer>
    <enteredDate value="2022-06-01T07:13:00+05:00"/>
    <supportingInformation>
        <reference value="#Abg123"/>
        <type value="DAV-PKV-PR-ERP-AbgabedatenBundle"/>
        <display value="Abgabedatensatz" />
    </supportingInformation>
</ChargeItem>
----
NOTE: In `<id value="Abg123"/>` befindet sich der Abgabgedatensatz als Contained-Bundle. Das Contained-Bundle wird später durch den Fachdienst als eigenständiges Bundle in "supportingInformation" referenziert.

NOTE: In `<value value="X234567890"/>` findet sich die Angabe eines PKV-Identifier.

NOTE: `<reference value="#Abg123"/>` enthält die Referenz auf das Contained-Objekt.
|===


*Response*
[source,xml]
----
HTTP/1.1 201 Created
Content-Type: application/fhir+xml;charset=utf-8

<ChargeItem xmlns="http://hl7.org/fhir">
    <id value="abc825bc-bc30-45f8-b109-1b343fff5c45" />
    <meta>
        <profile value="https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0" />
        <tag>
            <display value="Example of an ChargeItem." />
        </tag>
    </meta>
    <identifier>
        <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId" />
        <value value="200.086.824.605.539.20" />
    </identifier>
    <status value="billable" />
    <code>
        <coding>
            <system value="http://terminology.hl7.org/CodeSystem/data-absent-reason" />
            <code value="not-applicable" />
        </coding>
    </code>
    <subject>
        <identifier>
            <value value="X234567890" />
            <assigner>
                <display value="Name einer privaten Krankenversicherung" />
            </assigner>
        </identifier>
    </subject>
    <enterer>
        <identifier>
            <system value="https://gematik.de/fhir/sid/telematik-id" />
            <value value="3-15.2.1456789123.191" />
        </identifier>
    </enterer>
    <enteredDate value="2022-06-01T07:13:00+05:00"/>
    <supportingInformation>
        <reference value="200.086.824.605.539.20"/>
        <type value="DAV-PKV-PR-ERP-AbgabedatenBundle"/>
        <display value="Abgabedatensatz" />
    </supportingInformation>
</ChargeItem>
----


[cols="a,a"]
|===
|Code   |Type Success
|201  |Created +
[small]#Die Anfrage wurde erfolgreich bearbeitet.#
|Code   |Type Error
|400  |Bad Request +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut. Mögliche Gründe: Fehlender URL-Parameter task; Die übermittelte ChargeItem-Ressource ist nicht schema-konform.; Der übermittelte PKV-Abgabedatensatz ist nicht schema-konform.; Die Signatur des PKV-Abgabedatensatzes konnte nicht erfolgreich validiert werden.; Der referenzierte Task entspricht nicht den zulässigen FlowTypes.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt. Mögliche Gründe: Der authentifizierte Benutzer ist nicht berechtigt; Es liegt keine Einwilligung zum Speichern der Abrechnungsinformationen durch den Versicherten vor.; Fehlender URL-Parameter secret; Der in secret übermittelte Wert stimmt nicht mit dem Geheimnis in Task.secret überein.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Es wurde kein entsprechendes Task-Objekt mit dem Status Task.status = completed gefunden.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


==  Anwendungsfall Abrechnungsinformationen abrufen
Als Apotheker möchte ich eine von mir erstellte Abrechnungsinformation abrufen, um sie bearbeiten zu können oder sie zu kontrollieren. Falls die Abrechnung eine Korrektur benötigt, kann der Versicherte um eine Änderung des PKV-Abgabedatensatzes bitten. Liegen die Daten im System nicht mehr vor, übermittelt der Versicherte der Apotheke den AccessCode zum Ändern mittels einer Nachricht über das E-Rezept-FdV oder durch Anzeige zum Abscannen im E-Rezept-FdV.

Rückgabewert ist ein Bundle, welches das ChargeItem und den Abgabedatensatz, mit seiner Signatur im CAdES-Enveloping-Format, beinhaltet.

Der Aufruf erfolgt als http-`GET`-Operation auf die Ressource `/ChargeItem/'PrescriptionID'`. Im Aufruf muss das während der Authentisierung erhaltene ACCESS_TOKEN im http-Request-Header `Authorization` übergeben werden, der Fachdienst filtert die ChargeItem-Einträge nach der im ACCESS_TOKEN enthaltenen KVNR des Versicherten.

*Request*
[cols="h,a"]
|===
|URI        |https://prescriptionserver.telematik/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea
|Method     |GET
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE:  Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Versicherter aus, im Token ist seine Versichertennummer enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    | -
|===

*Response*
[source,xml]
----
HTTP/1.1 200 OK
Content-Type: application/fhir+json;charset=utf-8

<Bundle xmlns="http://hl7.org/fhir">
    <id value="4d8684f1-e379-4cb2-adcb-41ab1a543206"/>
    <meta>
        <lastUpdated value="2022-06-14T13:54:15.203+00:00"/>
    </meta>
    <type value="searchset"/>
    <total value="2"/>
    <entry>
        <fullUrl value="http://hapi.fhir.org/baseR4/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45"/>
        <resource>
            <ChargeItem xmlns="http://hl7.org/fhir">
                <id value="abc825bc-bc30-45f8-b109-1b343fff5c45" />
                <meta>
                    <profile value="https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0" />
                </meta>
                <identifier>
                    <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId" />
                    <value value="200.086.824.605.539.20" />
                </identifier>
                <identifier>
                    <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_AccessCode" />
                    <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea" />
                </identifier>
                <status value="billable" />
                <code>
                    <coding>
                        <system value="http://terminology.hl7.org/CodeSystem/data-absent-reason" />
                        <code value="not-applicable" />
                    </coding>
                </code>
                <subject>
                    <identifier>
                        <value value="X234567890" />
                        <assigner>
                            <display value="Name einer privaten Krankenversicherung" />
                        </assigner>
                    </identifier>
                </subject>
                <enterer>
                    <identifier>
                        <system value="https://gematik.de/fhir/sid/telematik-id" />
                        <value value="3-15.2.1456789123.191" />
                    </identifier>
                </enterer>
                <enteredDate value="2021-06-01T07:13:00+05:00" />
                <supportingInformation>
                    <reference value="72bd741c-7ad8-41d8-97c3-9aabbdd0f5b4" />
                    <display value="Abgabedatensatz" />
                </supportingInformation>
            </ChargeItem>
        </resource>
    </entry>
    <entry>
        <resource>
            <Bundle xmlns="http://hl7.org/fhir">
                <id value="ad80703d-8c62-44a3-b12b-2ea66eda0aa2" />
                <meta>
                    <profile value="http://fhir.abda.de/eRezeptAbgabedaten/StructureDefinition/DAV-PKV-PR-ERP-AbgabedatenBundle\|1.1" />
                    <tag>
                        <display value="Beispiel RezeptAbgabedatenPKV Bundle (FAM)" />
                    </tag>
                </meta>
                <identifier>
                    <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId" />
                    <value value="200.100.000.000.081.90" />
                </identifier>
                <type value="document" />
                <timestamp value="2022-03-24T11:30:00Z" />
                <entry>
                    <fullUrl value="urn:uuid:72183b44-61cf-4fe7-8f74-1e37d58fcea8" />
                    <resource>
                        <Composition>
                            <id value="72183b44-61cf-4fe7-8f74-1e37d58fcea8" />
                            <meta>
                                <profile value="http://fhir.abda.de/eRezeptAbgabedaten/StructureDefinition/DAV-PKV-PR-ERP-AbgabedatenComposition|1.1" />
                            </meta>
                            <status value="final" />
                            <type>
                                <coding>
                                    <system value="http://fhir.abda.de/eRezeptAbgabedaten/CodeSystem/DAV-CS-ERP-CompositionTypes" />
                                    <code value="ERezeptAbgabedaten" />
                                </coding>
                            </type>
                            <date value="2022-03-24T11:30:00Z" />
                            <author>
                                <reference value="urn:uuid:5dc67a4f-c936-4c26-a7c0-967673a70740" />
                            </author>
                            <title value="ERezeptAbgabedaten" />
                            <section>
                                <title value="Abgabeinformationen" />
                                <entry>
                                    <reference value="urn:uuid:335784b4-3f89-47cc-b32f-bc386a212e11" />
                                </entry>
                            </section>
                            <section>
                                <title value="Apotheke" />
                                <entry>
                                    <reference value="urn:uuid:5dc67a4f-c936-4c26-a7c0-967673a70740" />
                                </entry>
                            </section>
                        </Composition>
                    </resource>
                </entry>
            ...
                <signature>
                    <type>
                        <system value="urn:iso-astm:E1762-95:2013" />
                        <code value="1.2.840.10065.1.12.1.1" />
                    </type>
                    <when value="2020-03-20T07:31:34.328+00:00" />
                    <who>
                        <reference value="https://erp.zentral.erp.splitdns.ti-dienste.de/Device/ErxService" />
                    </who>
                    <sigFormat value="application/pkcs7-mime" />
                    <data value="ABCmZ3J1bmQg...." />
                </signature>
            </Bundle>
        </entry>
    </Bundle>
----
NOTE: Aus Gründen der besseren Lesbarkeit ist das PKV-Abgabdedatenbundle hier nicht vollständig dargestellt und wurde mit `...` abgekürzt.

NOTE: Das `<signature>` Element enthält die Signatur des Bundles über alle enthaltenen Objekte als Enveloping-CAdES-Signatur in Base64-Codierung.


[cols="a,a"]
|===
s|Code   s|Type Success
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wird im ResponseBody bereitgestellt.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== Anwendungsfall PKV-Abgabedatensatz ändern
Als Apotheke möchte ich einen von mir erstellten PKV-Abgabedatensatz auf Wunsch des Versicherten ändern. Liegen die Daten im System nicht mehr vor, übermittelt der Versicherte der Apotheke den AccessCode zum Ändern mittels einer Nachricht über das E-Rezept-FdV oder durch Anzeige zum Abscannen im E-Rezept-FdV.
Der zuvor im E-Rezept-Fachdienst gespeicherte PKV-Abgabedatensatz wird überschrieben. Es werden keine älteren Versionen im E-Rezept-Fachdienst gespeichert.

Der Aufruf erfolgt als http-`PUT`-Operation auf die Ressource `/ChargeItem/'PrescriptionID'`. Im Aufruf muss das während der Authentisierung erhaltene ACCESS_TOKEN im http-Request-Header `Authorization` übergeben werden.

*Request*
[cols="h,a"]
|===
|URI        |https://prescriptionserver.telematik/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf
|Method     |PUT
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Versicherter aus, im Token ist seine Versichertennummer enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    |
[source,xml]
----
<ChargeItem xmlns="http://hl7.org/fhir">
    <id value="abc825bc-bc30-45f8-b109-1b343fff5c45" />
    <meta>
        <profile value="https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0" />
    </meta>
    <contained>
        <Binary>
            <id value="Abg456"/>
            <!--Hier kommt das Abgabdedatensatz-Bundle rein. Siehe https://simplifier.net/erezeptabgabedatenpkv -->
        </Binary>
    </contained>
    <identifier>
        <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId" />
        <value value="200.086.824.605.539.20" />
    </identifier>
    <status value="billable" />
    <code>
        <coding>
            <system value="http://terminology.hl7.org/CodeSystem/data-absent-reason" />
            <code value="not-applicable" />
        </coding>
    </code>
    <subject>
        <identifier>
            <value value="X234567890" />
            <assigner>
                <display value="Name einer privaten Krankenversicherung" />
            </assigner>
        </identifier>
    </subject>
    <enterer>
        <identifier>
            <system value="https://gematik.de/fhir/sid/telematik-id" />
            <value value="3-15.2.1456789123.191" />
        </identifier>
    </enterer>
    <enteredDate value="2022-06-01T07:13:00+05:00"/>
    <supportingInformation>
        <reference value="#Abg456"/>
        <type value="DAV-PKV-PR-ERP-AbgabedatenBundle"/>
        <display value="Abgabedatensatz" />
    </supportingInformation>
</ChargeItem>
----
NOTE: In `<id value="Abg456"/>` fügt die abgebende LEI ihren geänderten Abgabedatensatz ein.
|===

*Response*
[source,xml]
----
HTTP/1.1 200 OK
Content-Type: application/fhir+xml;charset=utf-8

<ChargeItem xmlns="http://hl7.org/fhir">
    <id value="abc825bc-bc30-45f8-b109-1b343fff5c45" />
    <meta>
        <profile value="https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0" />
        <tag>
            <display value="Example of an ChargeItem." />
        </tag>
    </meta>
    <identifier>
        <system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId" />
        <value value="200.086.824.605.539.20" />
    </identifier>
    <status value="billable" />
    <code>
        <coding>
            <system value="http://terminology.hl7.org/CodeSystem/data-absent-reason" />
            <code value="not-applicable" />
        </coding>
    </code>
    <subject>
        <identifier>
            <value value="X234567890" />
            <assigner>
                <display value="Name einer privaten Krankenversicherung" />
            </assigner>
        </identifier>
    </subject>
    <enterer>
        <identifier>
            <system value="https://gematik.de/fhir/sid/telematik-id" />
            <value value="3-15.2.1456789123.191" />
        </identifier>
    </enterer>
    <enteredDate value="2022-06-01T07:13:00+05:00"/>
    <supportingInformation>
        <reference value="200.086.824.605.539.20"/>
        <type value="DAV-PKV-PR-ERP-AbgabedatenBundle"/>
        <display value="Abgabedatensatz" />
    </supportingInformation>
</ChargeItem>
----

[cols="a,a"]
|===
s|Code   s|Type Success
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wird im ResponseBody bereitgestellt.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist oder weil keine Einwilligung vorliegt.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== Anwendungsfall Abrechnungsinformationen durch den Versicherten abrufen
Als Versicherter möchte ich auf meine Abrechnungsinformationen zugreifen und diese in der E-Rezept-App einsehen können. Sind die Abrechunngsinformationen nicht bekannt (z.B. beim Wechsel des Smartphones), können diese mit einem GET-Befehl abgerufen werden. Werden ein oder mehrere ChargeItems gefunden, erfolgt die Rückgabe als Liste aller gefundenen ChargeItems ohne die im ChargeItem enthaltenen Referenzen.

Der Aufruf erfolgt als http-`GET`-Operation auf die Ressource `/ChargeItem`.

*Request*
[cols="h,a"]
|===
|URI        |https://erp.zentral.erp.splitdns.ti-dienste.de/ChargeItem/
|Method     |GET
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Versicherter aus, im Token ist seine Versichertennummer enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    | -
|===


*Response*
[source,json]
----
HTTP/1.1 200 OK
Content-Type: application/fhir+json;charset=utf-8

{
  "resourceType": "Bundle",
  "id": "200e3c55-b154-4335-a0ec-65addd39a3b6",
  "meta": {
    "lastUpdated": "2021-09-02T11:38:42.557+00:00"
  },
  "type": "searchset",
  "total": 2,
  "entry": [ {
    "fullUrl": "http://hapi.fhir.org/baseR4/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45",
    "resource": {
    "resourceType": "ChargeItem",
    "id": "abc825bc-bc30-45f8-b109-1b343fff5c45",
    "meta": {
        "profile":  [
            "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0"
        ]
    },
    "status": "billable",
    "extension":  [
        {
            "url": "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_EX_MarkingFlag",
            "extension":  [
                {
                    "url": "insuranceProvider",
                    "valueBoolean": false
                },
                {
                    "url": "subsidy",
                    "valueBoolean": false
                },
                {
                    "url": "taxOffice",
                    "valueBoolean": false
                }
            ]
        }
    ],
    "enterer": {
        "identifier": {
            "system": "https://gematik.de/fhir/sid/telematik-id",
            "value": "3-15.2.1456789123.191"
        }
    },
    "identifier":  [
        {
            "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId",
            "value": "200.086.824.605.539.20"
        },
        {
            "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_AccessCode",
            "value": "777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"
        }
    ],
    "code": {
        "coding":  [
            {
                "code": "not-applicable",
                "system": "http://terminology.hl7.org/CodeSystem/data-absent-reason"
            }
        ]
    },
    "subject": {
        "identifier": {
            "value": "X234567890",
            "assigner": {
                "display": "Name einer privaten Krankenversicherung"
            }
        }
    },
    "enteredDate": "2021-06-01T07:13:00+05:00",
    "supportingInformation":  [
        {
            "reference": "urn:uuid:0428d416-149e-48a4-977c-394887b3d85c",
            "display": "E-Rezept"
        },
        {
            "reference": "72bd741c-7ad8-41d8-97c3-9aabbdd0f5b4",
            "display": "Abgabedatensatz"
        },
        {
            "reference": "200.086.824.605.539.20",
            "display": "Quittung"
        }
    ]
},
    "search": {
      "mode": "match"
    }
  },{
    "fullUrl": "http://hapi.fhir.org/baseR4/ChargeItem/der124bc-bc30-45f8-b109-4h474wer2h89",
    "resource": {
    "resourceType": "ChargeItem",
    "id": "der124bc-bc30-45f8-b109-4h474wer2h89",
    "meta": {
        "profile":  [
            "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0"
        ]
    },
    "status": "billable",
    "extension":  [
        {
            "url": "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_EX_MarkingFlag",
            "extension":  [
                {
                    "url": "insuranceProvider",
                    "valueBoolean": false
                },
                {
                    "url": "subsidy",
                    "valueBoolean": false
                },
                {
                    "url": "taxOffice",
                    "valueBoolean": false
                }
            ]
        }
    ],
    "enterer": {
        "identifier": {
            "system": "https://gematik.de/fhir/sid/telematik-id",
            "value": "3-15.2.1456789123.191"
        }
    },
    "identifier":  [
        {
            "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId",
            "value": "200.086.824.605.539.20"
        },
        {
            "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_AccessCode",
            "value": "888bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"
        }
    ],
    "code": {
        "coding":  [
            {
                "code": "not-applicable",
                "system": "http://terminology.hl7.org/CodeSystem/data-absent-reason"
            }
        ]
    },
    "subject": {
        "identifier": {
            "value": "X234567890",
            "assigner": {
                "display": "Name einer privaten Krankenversicherung"
            }
        }
    },
    "enteredDate": "2021-06-01T07:13:00+05:00",
    "supportingInformation":  [
        {
            "reference": "urn:uuid:0428d416-149e-48a4-977c-394887b3d85c",
            "display": "E-Rezept"
        },
        {
            "reference": "72bd741c-7ad8-41d8-97c3-9aabbdd0f5b4",
            "display": "Abgabedatensatz"
        },
        {
            "reference": "200.086.824.605.539.20",
            "display": "Quittung"
        }
    ]
  }
  } ]
}
----
NOTE: Die angegebenen Referenzen werden in diesem Request nicht mitgeliefert. Im folgenden Request der das Chargeitem nach der Id abfragt sind diese Informationen dagegen enthalten.


Sind die ChargeItem-Instanzen in der App bekannt, kann direkt auf eine konkrete Instanz zugegriffen werden. Es wird das ChargeItem mit den referenzierten Bundles zurückgegeben.

Rückgabewert ist ein Bundle, welches das ChargeItem, den Verordnungsdatensatz, den Abgabedatensatz und die Quittung beinhaltet. An den drei Abrechnungsdatensätzen (Verordnungs-, Abgabedatensatz und an der Quittung hängt die Signatur im CAdES-Enveloping-Format).

*Request*
[cols="h,a"]
|===
|URI        |https://prescriptionserver.telematik/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45
|Method     |GET
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Versicherter aus, im Token ist seine Versichertennummer enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    |
|===


*Response*
[source,json]
----
HTTP/1.1 200 OK
Content-Type: application/fhir+json;charset=utf-8

{
    "resourceType": "Bundle",
    "id": "200e3c55-b154-4335-a0ec-65addd39a3b6",
    "meta": {
        "lastUpdated": "2021-09-02T11:38:42.557+00:00"
    },
    "type": "searchset",
    "total": 4,
    "entry": [
        {
            "fullUrl": "https://prescriptionserver.telematik/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45",
            "resource": {
                "resourceType": "ChargeItem",
                "id": "abc825bc-bc30-45f8-b109-1b343fff5c45",
                "meta": {
                    "profile": [
                        "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem\|1.0"
                    ]
                },
                "extension": [
                    {
                        "url": "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_EX_MarkingFlag",
                        "extension": [
                            {
                                "url": "insuranceProvider",
                                "valueBoolean": false
                            },
                            {
                                "url": "subsity",
                                "valueBoolean": false
                            },
                            {
                                "url": "taxOffice",
                                "valueBoolean": false
                            }
                        ]
                    }
                ],
                "identifier": {
                    "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId",
                    "value": "200.086.824.605.539.20"
                },
                "status": "billable",
                "code": {
                    "coding": [
                        {
                            "system": "http://terminology.hl7.org/CodeSystem/data-absent-reason",
                            "code": "not-applicable"
                        }
                    ]
                },
                "subject": {
                    "identifier": {
                        "system": "http://fhir.de/sid/pkv/kvid-10",
                        "value": "X234567890"
                    }
                },
                "enterer": {
                    "identifier": {
                        "system": "https://gematik.de/fhir/sid/telematik-id",
                        "value": "3-SMC-B-Testkarte-883110000095957"
                    }
                },
                "enteredDate": "2021-06-01T07:13:00+05:00",
                "supportingInformation": [
                    {
                        "reference": "f8c2298f-7c00-4a68-af29-8a2862d55d43",
                        "type": "https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle",
                        "display": "E-Rezept"
                    },
                    {
                        "reference": "ad80703d-8c62-44a3-b12b-2ea66eda0aa2",
                        "type": "http://fhir.abda.de/eRezeptAbgabedaten/StructureDefinition/DAV-PKV-PR-ERP-AbgabedatenBundle",
                        "display": "Abgabedatensatz"
                    },
                    {
                        "reference": "dffbfd6a-5712-4798-bdc8-07201eb77ab8",
                        "type": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_PR_Bundle|1.2",
                        "display": "Quittung"
                    }
                ]
            }
        },
        { /* Hier startet das Verordnungs-Bundle */
            "resource": {
                "resourceType": "Bundle",
                "id": "f8c2298f-7c00-4a68-af29-8a2862d55d43",
                "meta": {
                    "lastUpdated": "2020-02-03T12:30:02Z",
                    "profile": [
                        "https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle\|1.1.0"
                    ]
                },
                "identifier": {
                    "system": "urn:ietf:rfc:3986",
                    "value": "281a985c-f25b-4aae-91a6-41ad744080b0"
                },
                "type": "document",
                "timestamp": "2020-02-03T12:30:02Z",
                "entry": [
                    {
                        "fullUrl": "http://pvs.praxis-topp-gluecklich.local/fhir/Composition/ed52c1e3-b700-4497-ae19-b23744e29876",
                        "resource": {
                            "resourceType": "Composition",
                            "id": "ed52c1e3-b700-4497-ae19-b23744e29876",
                            "meta": {
                                "profile": [
                                    "https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Composition\|1.1.0"
                 ...
                                ]
                            }
                        }
                    }
                ],
                "signature": {
                "type": {
                        "system": "http://hl7.org/fhir/ValueSet/signature-type",
                        "code": "1.2.840.10065.1.12.1.1"
                    },
                    "when": "2020-03-20T07:31:34.328+00:00",
                    "who": "https://prescriptionserver.telematik/signature/verification",
                    "data": "eyJ0eXAiOiJKV1MiLCJhbGciOiJFUzI1NiIsIng1dSI6Imh0dHBzOi8vcHJlc2NyaXB0aW9uc2VydmVyLnRlbGVtYXRpay9zaWduYXR1cmUvY2VydGlmaWNhdGUifQ
                .
                eyJyZXNvdXJjZVR5cGUiOiJCdW5kbGUiLCJpZCI6ImY4YzIyOThmLTdjMDAtNGE2OC1hZjI5LThhMjg2MmQ1NWQ0MyIsImlkZW50aWZpZXIiOnsic3lzdGVtIjoiaHR0cHM6Ly9nZW1hdGlrLmRlL1ZhbHVlU2V0L0VSWF9QUkVTQ 1JJUFRJT05fSUQiLCJ2YWx1ZSI6Ik0xNi4xMjMuNDU2Ljc4OS4xMjMuMTMifSwidHlwZSI6ImRvY3VtZW50IiwiZW50cnkiOlt7ImZ1bGxVcmwiOiJodHRwOi8vcHZzLnByYXhpcy10b3BwLWdsdWVja2xpY2gubG9jYWwvZmhpci 9Db21wb3NpdGlvbi9lZDUyYzFlMy1iNzAwLTQ0OTctYWUxOS1iMjM3NDRlMjk4NzYiLCJyZXNvdXJjZSI6eyJyZXNvdXJjZVR5cGUiOiJDb21wb3NpdGlvbiJ9fSx7ImZ1bGxVcmwiOiJodHRwOi8vcHZzLnByYXhpcy10b3BwLWd sdWVja2xpY2gubG9jYWwvZmhpci9NZWRpY2F0aW9uUmVxdWVzdC9lOTMwY2RlZS05ZWI1LTRiNDQtODhiNS0yYTE4YjY5ZjNiOWEiLCJyZXNvdXJjZSI6eyJyZXNvdXJjZVR5cGUiOiJNZWRpY2F0aW9uUmVxdWVzdCJ9fV19
                . SSBhbSBhIHNpZ25hdHVyZSE="
                }
            }
        },
        { /* Hier startet das Abgabdedaten-Bundle */
            "resource": {
                "resourceType": "Bundle",
                "id": "ad80703d-8c62-44a3-b12b-2ea66eda0aa2",
                "meta": {
                    "profile": [
                        "http://fhir.abda.de/eRezeptAbgabedaten/StructureDefinition/DAV-PKV-PR-ERP-AbgabedatenBundle\|1.1"
                    ],
                    "tag": [
                        {
                            "display": "Beispiel RezeptAbgabedatenPKV Bundle (FAM)"
                        },
                        {
                            "display": "ACHTUNG! Der fachlich korrekte Inhalt der Beispielinstanz kann nicht gewährleistet werden. Wir sind jederzeit dankbar für Hinweise auf Fehler oder für Verbesserungsvorschläge."
                        }
                    ]
                },
                "type": "document",
                "identifier": {
                    "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId",
                    "value": "200.100.000.000.081.90"
                },
                "timestamp": "2022-03-24T11:30:00Z",
                "entry": [
                    {
                        "resource": {
                            "resourceType": "Composition",
                            "id": "72183b44-61cf-4fe7-8f74-1e37d58fcea8",
                            "meta": {
                                "profile": [
                                    "http://fhir.abda.de/eRezeptAbgabedaten/StructureDefinition/DAV-PKV-PR-ERP-AbgabedatenComposition\|1.1"
                                ],
                                ...
                            }
                        }
                    }
                ],
                "signature": {
                    "type": {
                        "system": "http://hl7.org/fhir/ValueSet/signature-type",
                        "code": "1.2.840.10065.1.12.1.1"
                    },
                    "when": "2020-03-20T07:31:34.328+00:00",
                    "who": "https://prescriptionserver.telematik/signature/verification",
                    "data": "eyJ0eXAiOiJKV1MiLCJhbGciOiJFUzI1NiIsIng1dSI6Imh0dHBzOi8vcHJlc2NyaXB0aW9uc2VydmVyLnRlbGVtYXRpay9zaWduYXR1cmUvY2VydGlmaWNhdGUifQ
                    .
                    eyJyZXNvdXJjZVR5cGUiOiJCdW5kbGUiLCJpZCI6ImY4YzIyOThmLTdjMDAtNGE2OC1hZjI5LThhMjg2MmQ1NWQ0MyIsImlkZW50aWZpZXIiOnsic3lzdGVtIjoiaHR0cHM6Ly9nZW1hdGlrLmRlL1ZhbHVlU2V0L0VSWF9QUkVTQ 1JJUFRJT05fSUQiLCJ2YWx1ZSI6Ik0xNi4xMjMuNDU2Ljc4OS4xMjMuMTMifSwidHlwZSI6ImRvY3VtZW50IiwiZW50cnkiOlt7ImZ1bGxVcmwiOiJodHRwOi8vcHZzLnByYXhpcy10b3BwLWdsdWVja2xpY2gubG9jYWwvZmhpci 9Db21wb3NpdGlvbi9lZDUyYzFlMy1iNzAwLTQ0OTctYWUxOS1iMjM3NDRlMjk4NzYiLCJyZXNvdXJjZSI6eyJyZXNvdXJjZVR5cGUiOiJDb21wb3NpdGlvbiJ9fSx7ImZ1bGxVcmwiOiJodHRwOi8vcHZzLnByYXhpcy10b3BwLWd sdWVja2xpY2gubG9jYWwvZmhpci9NZWRpY2F0aW9uUmVxdWVzdC9lOTMwY2RlZS05ZWI1LTRiNDQtODhiNS0yYTE4YjY5ZjNiOWEiLCJyZXNvdXJjZSI6eyJyZXNvdXJjZVR5cGUiOiJNZWRpY2F0aW9uUmVxdWVzdCJ9fV19
                    . SSBhbSBhIHNpZ25hdHVyZSE="
                }
            }
        },
        { /* Hier startet das Quittings-Bundle */
            "resource": {
                "resourceType": "Bundle",
                "id": "dffbfd6a-5712-4798-bdc8-07201eb77ab8",
                "meta": {
                    "profile": [
                        "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_PR_Bundle\|1.2"
                    ],
                    "tag": [
                        {
                            "display": "Receipt Bundle 'Quittung' for completed dispensation of a prescription"
                        }
                    ]
                },
                "type": "document",
                "identifier": {
                    "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId",
                    "value": "200.000.033.491.280.78"
                },
                "timestamp": "2022-03-18T15:28:00+00:00",
                "entry": [
                    {
                        "fullUrl": "urn:uuid:c624cf47-e235-4624-af71-0a09dc9254dc",
                        "resource": {
                            "resourceType": "Composition",
                            "id": "c624cf47-e235-4624-af71-0a09dc9254dc",
                            "meta": {
                                "profile": [
                                    "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_PR_Composition\|1.2"
                                ]
                            },
                            "status": "final",
                            "title": "Quittung",
                            "extension": [
                                {
                                    "url": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_Beneficiary",
                                    "valueIdentifier": {
                                        "system": "https://gematik.de/fhir/sid/telematik-id",
                                        "value": "3-SMC-B-Testkarte-883110000129070"
                                    }
                                }
                            ],
                           ...
                        }
                    },
                ],
                "signature": {
                    "type": [
                        {
                            "system": "urn:iso-astm:E1762-95:2013",
                            "code": "1.2.840.10065.1.12.1.1"
                        }
                    ],
                    "when": "2022-03-18T15:28:00+00:00",
                    "who": {
                        "reference": "https://erp.zentral.erp.splitdns.ti-dienste.de/Device/1"
                    },
                    "sigFormat": "application/pkcs7-mime",
                    "data": "MIII FQYJ KoZI hvcN AQcC oIII BjCC CAIC AQEx DzAN Bglg hkgB ZQME AgEF ADAL"
                }
            }
        }
    ]
}
----
NOTE: Das `signature` Element enthält die Signatur des Bundles über alle enthaltenen Objekte als Enveloping-CAdES-Signatur in Base64-Codierung.

NOTE: Aus Gründen der besseren Lesbarkeit ist das Bundle hier nicht vollständig dargestellt und wurde mit `...` abgekürzt

[cols="a,a"]
|===
s|Code   s|Type Success
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wird im ResponseBody bereitgestellt.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== Anwendungsfall Abrechnungsinformationen durch den Versicherten ändern
Als Versicherter möchte ich vorhandene Abrechnungsinformationen ändern, indem ich markiere, ob ich meine Abrechnungsdaten bei Abrechnungsstellen eingereicht habe.

Der Aufruf erfolgt als http-`PATCH`-Operation auf die Ressource `/ChargeItem`.

*Request*
[cols="h,a"]
|===
|URI        |https://prescriptionserver.telematik/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45
|Method     |PATCH
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
Content-Type: application/fhir+json; charset=utf-8
----
NOTE:  Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Versicherter aus, im Token ist seine Versichertennummer enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    |
[source,json]
----
{
  "resourceType": "Parameters",
  "parameter": [
    {
      "name": "operation",
      "part": [
        {
          "name": "type",
          "valueCode": "add"
        },
        {
          "name": "path",
          "valueString": "ChargeItem.extension('https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_MarkingFlag').extension('taxOffice')"
        },
        {
          "name": "name",
          "valueString": "valueBoolean"
        },
        {
          "name": "value",
          "valueBoolean": true
        }
      ]
    },
    {
      "name": "operation",
      "part": [
        {
          "name": "type",
          "valueCode": "add"
        },
        {
          "name": "path",
           "valueString": "ChargeItem.extension('https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_MarkingFlag').extension('insuranceProvider')"
        },
        {
          "name": "name",
          "valueString": "valueBoolean"
        },
        {
          "name": "value",
          "valueBoolean": false
        }
      ]
    }
  ]
}
----
NOTE: In `"valueString": "ChargeItem.extension('https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_MarkingFlag').extension('taxOffice')"` ist der Pfadanfang, an dem das zu ändernde Attribut hängt definiert.

NOTE: Im `"valueString": "ChargeItem.extension('https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_MarkingFlag').extension('insuranceProvider')"` Element, welches geändert werden soll.
|===


*Response*
[source,json]
----
HTTP/1.1 200 OK
Content-Type: application/fhir+json;charset=utf-8

{
  "resourceType": "ChargeItem",
  "id": "2872799",
  "meta": {
    "versionId": "1",
    "lastUpdated": "2022-04-05T11:36:19.491+00:00",
    "source": "#V4se2kvNDlSKuefe",
    "profile": [ "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_PR_ChargeItem" ]
  },
  "extension": [ {
    "url": "https://gematik.de/fhir/erpchrg/StructureDefinition/GEM_ERPCHRG_EX_MarkingFlag",
    "extension": [ {
      "url": "insuranceProvider",
      "valueBoolean": true
    }, {
      "url": "subsity",
      "valueBoolean": false
    }, {
      "url": "taxOffice",
      "valueBoolean": true
    } ]
  } ],
  "identifier": [ {
    "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId",
    "value": "200.086.824.605.539.20"
  }, {
    "system": "https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_AccessCode",
    "value": "555bjf73jr8d9si2ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"
  } ],
  "status": "billable",
  "code": {
    "coding": [ {
      "system": "http://terminology.hl7.org/CodeSystem/data-absent-reason",
      "code": "not-applicable"
    } ]
  },
  "subject": {


    "identifier": {
      "system": "http://fhir.de/sid/pkv/kvid-10",
      "value": "X234567890"
    }
  },
  "enterer": {
    "identifier": {
      "system": "https://gematik.de/fhir/sid/telematik-id",
      "value": "3-SMC-B-Testkarte-883110000095957"
    }
  },
  "enteredDate": "2021-06-01T07:13:00+05:00",
  "supportingInformation": [ {
    "reference": "Bundle/0428d416-149e-48a4-977c-394887b3d85c",
    "display": "E-Rezept"
  }, {
    "reference": "Bundle/72bd741c-7ad8-41d8-97c3-9aabbdd0f5b4",
    "display": "Abgabedatensatz"
  }, {
    "reference": "Bundle/200.086.824.605.539.20",
    "display": "Quittung"
  } ]
}
----

[cols="a,a"]
|===
s|Code   s|Type Success
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


==  Anwendungsfall Löschen der Abrechnungsinformationen durch den Versicherten
Als Versicherter möchte ich eine durch die Apotheke eingestellte Abrechnungsinformation löschen. Das Löschen erfolgt unwiederbringlich.

Der Aufruf erfolgt als http-`DELETE`-Operation auf die Ressource `/ChargeItem`. Im Aufruf muss das während der Authentisierung erhaltene ACCESS_TOKEN im http-Request-Header `Authorization` übergeben werden, der Fachdienst filtert die Consent-Einträge nach der im ACCESS_TOKEN enthaltenen KVNR des Versicherten.

*Request*
[cols="h,a"]
|===
|URI        |https://prescriptionserver.telematik/ChargeItem/abc825bc-bc30-45f8-b109-1b343fff5c45
|Method     |DELETE
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
X-AccessCode: 777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea
----
NOTE: Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Versicherter aus, im Token ist seine Versichertennummer enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    |
|===


*Response*
[source,json]
----
HTTP/1.1 204 No Content
----

[cols="a,a"]
|===
s|Code   s|Type Success
|204  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   s|Type Error
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===
